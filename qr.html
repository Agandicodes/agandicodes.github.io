<!DOCTYPE html>
<html lang="en">
<head>
  <title>QR Code Generator</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      background: linear-gradient(135deg, #89f7fe, #66a6ff);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .form-container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 90%;
      width: 350px;
    }
    #qrcode {
      background: white;
      padding: 10px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #downloadBtn {
      margin-top: 10px;
      padding: 8px 15px;
      border-radius: 8px;
      border: none;
      background: #2196F3;
      color: white;
      cursor: pointer;
    }
    .logo-status {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
      text-align: center;
    }
    .logo-success {
      color: #4CAF50;
    }
    .logo-error {
      color: #f44336;
    }
  </style>
</head>
<body>

<div class="form-container">
  <h2>QR Code Generator</h2>
  <input type="text" id="textInput" placeholder="Enter URL, phone, email..." />
  <input type="file" id="logoInput" accept="image/*">
  <div id="logoStatus" class="logo-status"></div>
  <button onclick="generateQRCode()">Generate QR Code</button>

  <div id="qrcode-container">
    <div id="qrcode"></div>
    <button id="downloadBtn" style="display:none;" onclick="downloadQR()">Download QR Code</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
let logoDataURL = null;
let qrCodeInstance = null;

// Improved logo loading with status feedback
document.getElementById("logoInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) {
        updateLogoStatus("No file selected", true);
        return;
    }

    // Validate file type
    if (!file.type.match('image.*')) {
        updateLogoStatus("Please select an image file (JPEG, PNG, etc.)", true);
        return;
    }

    // Validate file size (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
        updateLogoStatus("Image too large (max 2MB)", true);
        return;
    }

    updateLogoStatus("Loading logo...");
    
    const reader = new FileReader();
    reader.onload = function(event) {
        // Test the image can actually be loaded
        const testImg = new Image();
        testImg.onload = function() {
            logoDataURL = event.target.result;
            updateLogoStatus("Logo ready!", false);
            // Store temporarily
            try { 
                localStorage.setItem("tempLogo", logoDataURL); 
            } catch(e) {
                console.warn("Could not store logo in localStorage", e);
            }
        };
        testImg.onerror = function() {
            updateLogoStatus("Invalid image file", true);
            logoDataURL = null;
        };
        testImg.src = event.target.result;
    };
    reader.onerror = function() {
        updateLogoStatus("Error reading file", true);
        // Try to load from storage if available
        logoDataURL = localStorage.getItem("tempLogo") || null;
        if (logoDataURL) {
            updateLogoStatus("Using previously saved logo", false);
        }
    };
    reader.readAsDataURL(file);
});

function updateLogoStatus(message, isError = false) {
    const statusElement = document.getElementById('logoStatus');
    statusElement.textContent = message;
    statusElement.className = isError ? 'logo-status logo-error' : 'logo-status logo-success';
}

function generateQRCode() {
    const text = document.getElementById('textInput').value.trim();
    if (!text) return alert("Please enter text!");

    // Clear previous QR code
    document.getElementById('qrcode').innerHTML = "";
    
    // Generate QR code
    qrCodeInstance = new QRCode(document.getElementById("qrcode"), {
        text: text,
        width: 250,
        height: 250,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });

    // Add logo after a small delay to ensure QR code is rendered
    setTimeout(addLogoToQR, 100);
    
    document.getElementById('downloadBtn').style.display = "block";
}

function addLogoToQR() {
    if (!logoDataURL) return;

    const canvas = document.querySelector('#qrcode canvas');
    if (!canvas) {
        console.warn("QR canvas not found");
        return;
    }

    const img = new Image();
    img.onload = function() {
        try {
            const ctx = canvas.getContext('2d');
            const logoSize = canvas.width * 0.2;
            const x = (canvas.width - logoSize) / 2;
            const y = (canvas.height - logoSize) / 2;
            
            // Save the original QR code data
            const qrImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Draw the logo
            ctx.drawImage(img, x, y, logoSize, logoSize);
            
            updateLogoStatus("Logo added successfully!", false);
        } catch (err) {
            console.error("Error drawing logo:", err);
            updateLogoStatus("Error adding logo", true);
        }
    };
    img.onerror = function() {
        updateLogoStatus("Failed to load logo image", true);
        // Remove invalid logo from storage
        try { localStorage.removeItem("tempLogo"); } catch(e) {}
        logoDataURL = null;
    };
    img.src = logoDataURL;
}

function downloadQR() {
    const canvas = document.querySelector('#qrcode canvas');
    if (!canvas) {
        alert("Please generate a QR code first");
        return;
    }
    
    const link = document.createElement('a');
    link.href = canvas.toDataURL("image/png");
    link.download = "qr_code.png";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Load any previously saved logo on page load
window.addEventListener('DOMContentLoaded', function() {
    const storedLogo = localStorage.getItem("tempLogo");
    if (storedLogo) {
        logoDataURL = storedLogo;
        updateLogoStatus("Previously saved logo available", false);
    }
});
</script>
</body>
</html>
